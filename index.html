<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll Manager Pro - Enterprise Payroll Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: var(--bg-white);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 8px;
        }

        .login-header p {
            color: var(--text-light);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .link-button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 14px;
            text-decoration: underline;
            padding: 0;
        }

        .link-button:hover {
            color: var(--primary-dark);
        }

        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .top-nav {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .nav-brand {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-light);
        }

        .main-container {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        .sidebar {
            width: 260px;
            background: var(--bg-white);
            border-right: 1px solid var(--border);
            padding: 24px 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 4px;
        }

        .sidebar-menu button {
            width: 100%;
            padding: 12px 24px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark);
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-menu button:hover {
            background: var(--bg-light);
        }

        .sidebar-menu button.active {
            background: var(--primary);
            color: white;
        }

        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: 24px;
        }

        .content-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .content-header p {
            color: var(--text-light);
            font-size: 14px;
        }

        .card {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        table th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-dark);
        }

        table tr:hover {
            background: var(--bg-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .company-selector {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-white);
            cursor: pointer;
            min-width: 200px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* Payslip Print Styles */
        .payslip-print {
            background: white;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .payslip-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 20px;
        }

        .payslip-table {
            width: 100%;
            margin-bottom: 20px;
        }

        .payslip-table th,
        .payslip-table td {
            padding: 8px;
            border: 1px solid #000;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
            }
            
            .payslip-print {
                padding: 0;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -260px;
                top: 65px;
                height: calc(100vh - 65px);
                z-index: 100;
                transition: left 0.3s;
            }

            .sidebar.active {
                left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: scroll;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Section -->
    <div id="authSection" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>üíº Payroll Manager Pro</h1>
                <p>Enterprise Payroll Management System</p>
            </div>

            <div id="alertContainer"></div>

            <!-- Login Form -->
            <div id="loginForm">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span id="loginBtnText">Sign In</span>
                        <span id="loginLoader" class="loading hidden"></span>
                    </button>
                    <div class="text-center mt-3">
                        <button type="button" class="link-button" onclick="showRegisterForm()">Create Account</button> | 
                        <button type="button" class="link-button" onclick="showResetForm()">Forgot Password?</button>
                    </div>
                </form>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="regPhone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="regPassword" minlength="6" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Account</button>
                    <div class="text-center mt-3">
                        <button type="button" class="link-button" onclick="showLoginForm()">Back to Sign In</button>
                    </div>
                </form>
            </div>

            <!-- Reset Password Form -->
            <div id="resetForm" class="hidden">
                <form onsubmit="handleResetPassword(event)">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="resetEmail" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Reset Link</button>
                    <div class="text-center mt-3">
                        <button type="button" class="link-button" onclick="showLoginForm()">Back to Sign In</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="dashboard">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-brand">üíº Payroll Manager Pro</div>
            <div class="nav-user">
                <select id="companySelector" class="company-selector" onchange="handleCompanyChange()" style="display:none;">
                    <option value="">Select Company</option>
                </select>
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole"></div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="handleLogout()">Logout</button>
            </div>
        </nav>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <ul class="sidebar-menu" id="sidebarMenu">
                    <li><button onclick="showTab('dashboard')" class="active">üìä Dashboard</button></li>
                    <li id="menuCompanies" class="hidden"><button onclick="showTab('companies')">üè¢ Companies</button></li>
                    <li id="menuEmployees"><button onclick="showTab('employees')">üë• Employees</button></li>
                    <li id="menuPayslips"><button onclick="showTab('payslips')">üí∞ Payslips</button></li>
                    <li id="menuReports"><button onclick="showTab('reports')">üìà Reports</button></li>
                    <li id="menuSettings"><button onclick="showTab('settings')">‚öôÔ∏è Settings</button></li>
                </ul>
            </aside>

            <!-- Content Area -->
            <main class="content">
                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content">
                    <div class="content-header">
                        <h2>Dashboard</h2>
                        <p>Overview of your payroll system</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Companies</div>
                            <div class="stat-value" id="totalCompanies">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Employees</div>
                            <div class="stat-value" id="totalEmployees">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Employees</div>
                            <div class="stat-value" id="activeEmployees">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">This Month Payslips</div>
                            <div class="stat-value" id="monthPayslips">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div id="recentActivity">
                            <p class="text-center" style="padding: 40px; color: var(--text-light);">No recent activity</p>
                        </div>
                    </div>
                </div>

                <!-- Companies Tab -->
                <div id="companiesTab" class="tab-content hidden">
                    <div class="content-header">
                        <h2>Companies</h2>
                        <p>Manage your companies</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Companies</h3>
                            <button class="btn btn-primary btn-sm" onclick="openAddCompanyModal()">+ Add Company</button>
                        </div>
                        <div class="table-container">
                            <table id="companiesTable">
                                <thead>
                                    <tr>
                                        <th>Company Name</th>
                                        <th>PAN</th>
                                        <th>Admin</th>
                                        <th>Employees</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="companiesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center" style="padding: 40px;">No companies found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Employees Tab -->
                <div id="employeesTab" class="tab-content hidden">
                    <div class="content-header">
                        <h2>Employees</h2>
                        <p>Manage employee records</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Employees</h3>
                            <button class="btn btn-primary btn-sm" onclick="openAddEmployeeModal()">+ Add Employee</button>
                        </div>
                        <div class="table-container">
                            <table id="employeesTable">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Designation</th>
                                        <th>Department</th>
                                        <th>Basic Salary</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center" style="padding: 40px;">Select a company to view employees</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payslips Tab -->
                <div id="payslipsTab" class="tab-content hidden">
                    <div class="content-header">
                        <h2>Payslips</h2>
                        <p>Generate and manage payslips</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Payslips</h3>
                        </div>
                        <div class="table-container">
                            <table id="payslipsTable">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Month</th>
                                        <th>Year</th>
                                        <th>Gross Salary</th>
                                        <th>Net Salary</th>
                                        <th>Generated On</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payslipsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center" style="padding: 40px;">No payslips found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reportsTab" class="tab-content hidden">
                    <div class="content-header">
                        <h2>Reports</h2>
                        <p>View payroll reports and analytics</p>
                    </div>
                    <div class="card">
                        <p class="text-center" style="padding: 40px;">Reports feature coming soon...</p>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content hidden">
                    <div class="content-header">
                        <h2>Settings</h2>
                        <p>Configure your account and system settings</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Account Information</h3>
                        <div id="settingsContent">
                            <p><strong>Name:</strong> <span id="settingsName"></span></p>
                            <p><strong>Email:</strong> <span id="settingsEmail"></span></p>
                            <p><strong>Role:</strong> <span id="settingsRole"></span></p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Company Modal -->
    <div id="addCompanyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Company</h3>
                <button class="modal-close" onclick="closeModal('addCompanyModal')">&times;</button>
            </div>
            <form onsubmit="handleAddCompany(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Company Name *</label>
                        <input type="text" class="form-control" id="companyName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">PAN Number</label>
                            <input type="text" class="form-control" id="companyPAN" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">TAN Number</label>
                            <input type="text" class="form-control" id="companyTAN">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">PF Number</label>
                            <input type="text" class="form-control" id="companyPF">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ESI Number</label>
                            <input type="text" class="form-control" id="companyESI">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="companyAddress" rows="3"></textarea>
                    </div>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
                    <h4 style="margin-bottom: 16px;">Company Admin Details</h4>
                    <div class="form-group">
                        <label class="form-label">Admin Name *</label>
                        <input type="text" class="form-control" id="adminName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Admin Email *</label>
                            <input type="email" class="form-control" id="adminEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Admin Phone *</label>
                            <input type="tel" class="form-control" id="adminPhone" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCompanyModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Company</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Employee</h3>
                <button class="modal-close" onclick="closeModal('addEmployeeModal')">&times;</button>
            </div>
            <form onsubmit="handleAddEmployee(event)">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Employee ID *</label>
                            <input type="text" class="form-control" id="employeeId" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="employeeName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="employeeEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="employeePhone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Designation *</label>
                            <input type="text" class="form-control" id="employeeDesignation" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department *</label>
                            <input type="text" class="form-control" id="employeeDepartment" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date of Joining</label>
                            <input type="date" class="form-control" id="employeeDOJ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Basic Salary *</label>
                            <input type="number" class="form-control" id="employeeBasicSalary" required min="0" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">PAN Number</label>
                            <input type="text" class="form-control" id="employeePAN" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">UAN Number</label>
                            <input type="text" class="form-control" id="employeeUAN">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bank Account Number</label>
                        <input type="text" class="form-control" id="employeeBank">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="employeeAccess"> Grant Website Access (Login)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addEmployeeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generate Payslip Modal -->
    <div id="generatePayslipModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Generate Payslip</h3>
                <button class="modal-close" onclick="closeModal('generatePayslipModal')">&times;</button>
            </div>
            <form onsubmit="handleGeneratePayslip(event)">
                <div class="modal-body">
                    <input type="hidden" id="payslipEmployeeId">
                    <div class="form-group">
                        <label class="form-label">Employee Name</label>
                        <input type="text" class="form-control" id="payslipEmployeeName" readonly>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Month *</label>
                            <select class="form-control" id="payslipMonth" required>
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Year *</label>
                            <input type="number" class="form-control" id="payslipYear" required min="2020" max="2030" value="2025">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Working Days *</label>
                            <input type="number" class="form-control" id="workingDays" required min="1" max="31" value="26">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Paid Days *</label>
                            <input type="number" class="form-control" id="paidDays" required min="0" max="31" value="26">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Basic Salary</label>
                        <input type="number" class="form-control" id="payslipBasicSalary" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Additional Allowances</label>
                        <input type="number" class="form-control" id="additionalAllowances" min="0" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Other Deductions</label>
                        <input type="number" class="form-control" id="otherDeductions" min="0" step="0.01" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('generatePayslipModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Payslip</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Payslip Modal -->
    <div id="viewPayslipModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Payslip</h3>
                <button class="modal-close" onclick="closeModal('viewPayslipModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="payslipContent"></div>
            </div>
            <div class="modal-footer no-print">
                <button type="button" class="btn btn-secondary" onclick="closeModal('viewPayslipModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ===================================
        // FIREBASE CONFIGURATION
        // ===================================
        // IMPORTANT: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let currentUser = null;
        let currentUserData = null;
        let currentCompanyId = null;
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 5;

        // ===================================
        // AUTHENTICATION FUNCTIONS
        // ===================================

        // Show/Hide Forms
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('resetForm').classList.add('hidden');
            clearAlert();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('resetForm').classList.add('hidden');
            clearAlert();
        }

        function showResetForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('resetForm').classList.remove('hidden');
            clearAlert();
        }

        // Handle Login
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            document.getElementById('loginBtnText').classList.add('hidden');
            document.getElementById('loginLoader').classList.remove('hidden');

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Check if user document exists
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    throw new Error('User data not found. Please contact administrator.');
                }

                const userData = userDoc.data();

                // Check if account is locked
                if (userData.isLocked) {
                    const lockUntil = userData.lockedUntil?.toDate();
                    if (lockUntil && lockUntil > new Date()) {
                        throw new Error('Account is locked. Please try again later.');
                    } else {
                        // Unlock account
                        await db.collection('users').doc(user.uid).update({
                            isLocked: false,
                            loginAttempts: 0,
                            lockedUntil: null
                        });
                    }
                }

                // Reset login attempts on successful login
                await db.collection('users').doc(user.uid).update({
                    loginAttempts: 0,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });

                loginAttempts = 0;
                showAlert('Login successful!', 'success');
                
                // User will be redirected by onAuthStateChanged listener
            } catch (error) {
                console.error('Login error:', error);
                loginAttempts++;
                
                let errorMessage = 'Login failed. Please check your credentials.';
                
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    errorMessage = `Invalid email or password. Attempt ${loginAttempts}/${MAX_LOGIN_ATTEMPTS}`;
                    
                    if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                        errorMessage = 'Too many failed attempts. Please contact administrator.';
                        // In real implementation, lock the account here
                    }
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed login attempts. Please try again later.';
                } else {
                    errorMessage = error.message;
                }
                
                showAlert(errorMessage, 'danger');
            } finally {
                document.getElementById('loginBtnText').classList.remove('hidden');
                document.getElementById('loginLoader').classList.add('hidden');
            }
        }

        // Handle Register
        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;

            try {
                // Create user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Check if this is the first user (will be Super Admin)
                const usersSnapshot = await db.collection('users').get();
                const isSuperAdmin = usersSnapshot.empty;

                // Create user document
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    phoneNumber: phone,
                    role: isSuperAdmin ? 'Super Admin' : 'Employee',
                    companyId: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isLocked: false,
                    loginAttempts: 0
                });

                showAlert(isSuperAdmin ? 
                    'Account created successfully! You are the Super Admin.' : 
                    'Account created successfully! Please wait for administrator approval.', 
                    'success'
                );
                
                setTimeout(() => showLoginForm(), 2000);
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Registration failed. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                }
                
                showAlert(errorMessage, 'danger');
            }
        }

        // Handle Reset Password
        async function handleResetPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('resetEmail').value;

            try {
                await auth.sendPasswordResetEmail(email);
                showAlert('Password reset link sent to your email!', 'success');
                setTimeout(() => showLoginForm(), 3000);
            } catch (error) {
                console.error('Reset error:', error);
                showAlert('Failed to send reset link. Please check your email address.', 'danger');
            }
        }

        // Handle Logout
        async function handleLogout() {
            try {
                await auth.signOut();
                showAlert('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('Error logging out', 'danger');
            }
        }

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                        
                        // Show dashboard
                        document.getElementById('authSection').style.display = 'none';
                        document.getElementById('dashboardSection').classList.add('active');
                        
                        // Update UI
                        document.getElementById('userName').textContent = currentUserData.name;
                        document.getElementById('userRole').textContent = currentUserData.role;
                        
                        // Setup menu based on role
                        setupMenuForRole(currentUserData.role);
                        
                        // Load initial data
                        await loadDashboardData();
                        
                        // If not Super Admin, load company selector
                        if (currentUserData.role !== 'Super Admin') {
                            if (currentUserData.companyId) {
                                currentCompanyId = currentUserData.companyId;
                                await loadCompanyData();
                            }
                        } else {
                            document.getElementById('companySelector').style.display = 'block';
                            await loadCompanySelector();
                        }
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showAlert('Error loading user data', 'danger');
                }
            } else {
                currentUser = null;
                currentUserData = null;
                currentCompanyId = null;
                
                // Show login
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('dashboardSection').classList.remove('active');
            }
        });

        // ===================================
        // UI HELPER FUNCTIONS
        // ===================================

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            
            setTimeout(() => clearAlert(), 5000);
        }

        function clearAlert() {
            document.getElementById('alertContainer').innerHTML = '';
        }

        function setupMenuForRole(role) {
            const menuCompanies = document.getElementById('menuCompanies');
            const menuEmployees = document.getElementById('menuEmployees');
            const menuPayslips = document.getElementById('menuPayslips');
            const menuReports = document.getElementById('menuReports');
            const menuSettings = document.getElementById('menuSettings');

            if (role === 'Super Admin') {
                menuCompanies.classList.remove('hidden');
                menuEmployees.classList.remove('hidden');
                menuPayslips.classList.remove('hidden');
                menuReports.classList.remove('hidden');
                menuSettings.classList.remove('hidden');
            } else if (role === 'Company Admin' || role === 'HR Manager') {
                menuCompanies.classList.add('hidden');
                menuEmployees.classList.remove('hidden');
                menuPayslips.classList.remove('hidden');
                menuReports.classList.remove('hidden');
                menuSettings.classList.remove('hidden');
            } else {
                menuCompanies.classList.add('hidden');
                menuEmployees.classList.add('hidden');
                menuPayslips.classList.remove('hidden');
                menuReports.classList.add('hidden');
                menuSettings.classList.remove('hidden');
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.add('hidden'));
            
            // Remove active class from all menu items
            const menuButtons = document.querySelectorAll('.sidebar-menu button');
            menuButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Add active class to clicked menu item
            event.target.classList.add('active');
            
            // Load tab data
            if (tabName === 'companies') loadCompanies();
            else if (tabName === 'employees') loadEmployees();
            else if (tabName === 'payslips') loadPayslips();
            else if (tabName === 'settings') loadSettings();
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ===================================
        // DATA LOADING FUNCTIONS
        // ===================================

        async function loadDashboardData() {
            try {
                let companiesCount = 0;
                let employeesCount = 0;
                let activeEmployees = 0;
                let monthPayslips = 0;

                if (currentUserData.role === 'Super Admin') {
                    const companiesSnapshot = await db.collection('companies').get();
                    companiesCount = companiesSnapshot.size;
                    
                    const employeesSnapshot = await db.collection('employees').get();
                    employeesCount = employeesSnapshot.size;
                    activeEmployees = employeesSnapshot.docs.filter(doc => 
                        doc.data().status === 'Active'
                    ).length;
                } else if (currentUserData.companyId) {
                    companiesCount = 1;
                    
                    const employeesSnapshot = await db.collection('employees')
                        .where('companyId', '==', currentUserData.companyId)
                        .get();
                    employeesCount = employeesSnapshot.size;
                    activeEmployees = employeesSnapshot.docs.filter(doc => 
                        doc.data().status === 'Active'
                    ).length;
                }

                // Get current month payslips
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                let payslipsQuery = db.collection('payslips')
                    .where('month', '==', currentMonth.toString().padStart(2, '0'))
                    .where('year', '==', currentYear);
                
                if (currentUserData.role !== 'Super Admin' && currentUserData.companyId) {
                    payslipsQuery = payslipsQuery.where('companyId', '==', currentUserData.companyId);
                }
                
                const payslipsSnapshot = await payslipsQuery.get();
                monthPayslips = payslipsSnapshot.size;

                // Update UI
                document.getElementById('totalCompanies').textContent = companiesCount;
                document.getElementById('totalEmployees').textContent = employeesCount;
                document.getElementById('activeEmployees').textContent = activeEmployees;
                document.getElementById('monthPayslips').textContent = monthPayslips;
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadCompanySelector() {
            try {
                const companiesSnapshot = await db.collection('companies').get();
                const selector = document.getElementById('companySelector');
                
                selector.innerHTML = '<option value="">Select Company</option>';
                
                companiesSnapshot.forEach(doc => {
                    const company = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = company.name;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        async function handleCompanyChange() {
            const selector = document.getElementById('companySelector');
            currentCompanyId = selector.value;
            
            if (currentCompanyId) {
                await loadCompanyData();
            }
        }

        async function loadCompanyData() {
            await loadDashboardData();
            await loadEmployees();
            await loadPayslips();
        }

        async function loadCompanies() {
            try {
                const companiesSnapshot = await db.collection('companies').get();
                const tbody = document.getElementById('companiesTableBody');
                
                if (companiesSnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 40px;">No companies found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                for (const doc of companiesSnapshot.docs) {
                    const company = doc.data();
                    
                    // Get employee count
                    const employeesSnapshot = await db.collection('employees')
                        .where('companyId', '==', doc.id)
                        .get();
                    
                    const row = `
                        <tr>
                            <td>${company.name}</td>
                            <td>${company.pan || 'N/A'}</td>
                            <td>${company.adminName || 'N/A'}</td>
                            <td>${employeesSnapshot.size}</td>
                            <td><span class="badge badge-success">Active</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-primary" onclick="editCompany('${doc.id}')">Edit</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            } catch (error) {
                console.error('Error loading companies:', error);
                showAlert('Error loading companies', 'danger');
            }
        }

        async function loadEmployees() {
            try {
                if (!currentCompanyId && currentUserData.role !== 'Super Admin') {
                    document.getElementById('employeesTableBody').innerHTML = 
                        '<tr><td colspan="7" class="text-center" style="padding: 40px;">Select a company to view employees</td></tr>';
                    return;
                }
                
                let query = db.collection('employees');
                
                if (currentCompanyId) {
                    query = query.where('companyId', '==', currentCompanyId);
                } else if (currentUserData.role !== 'Super Admin' && currentUserData.companyId) {
                    query = query.where('companyId', '==', currentUserData.companyId);
                }
                
                const employeesSnapshot = await query.get();
                const tbody = document.getElementById('employeesTableBody');
                
                if (employeesSnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="padding: 40px;">No employees found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                employeesSnapshot.forEach(doc => {
                    const employee = doc.data();
                    const statusBadge = employee.status === 'Active' ? 'badge-success' : 
                                       employee.status === 'Resigned' ? 'badge-warning' : 'badge-danger';
                    
                    const row = `
                        <tr>
                            <td>${employee.employeeId}</td>
                            <td>${employee.name}</td>
                            <td>${employee.designation || 'N/A'}</td>
                            <td>${employee.department || 'N/A'}</td>
                            <td>‚Çπ${parseFloat(employee.basicSalary || 0).toLocaleString('en-IN')}</td>
                            <td><span class="badge ${statusBadge}">${employee.status || 'Active'}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-success" onclick="openGeneratePayslipModal('${doc.id}', '${employee.name}', ${employee.basicSalary})">üí∞ Payslip</button>
                                    <button class="btn btn-sm btn-primary" onclick="editEmployee('${doc.id}')">Edit</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading employees:', error);
                showAlert('Error loading employees', 'danger');
            }
        }

        async function loadPayslips() {
            try {
                let query = db.collection('payslips').orderBy('createdAt', 'desc').limit(50);
                
                if (currentCompanyId) {
                    query = db.collection('payslips')
                        .where('companyId', '==', currentCompanyId)
                        .orderBy('createdAt', 'desc')
                        .limit(50);
                } else if (currentUserData.role === 'Employee' && currentUser) {
                    query = db.collection('payslips')
                        .where('employeeId', '==', currentUser.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(50);
                } else if (currentUserData.companyId) {
                    query = db.collection('payslips')
                        .where('companyId', '==', currentUserData.companyId)
                        .orderBy('createdAt', 'desc')
                        .limit(50);
                }
                
                const payslipsSnapshot = await query.get();
                const tbody = document.getElementById('payslipsTableBody');
                
                if (payslipsSnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="padding: 40px;">No payslips found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                payslipsSnapshot.forEach(doc => {
                    const payslip = doc.data();
                    const createdAt = payslip.createdAt?.toDate().toLocaleDateString('en-IN');
                    
                    const row = `
                        <tr>
                            <td>${payslip.employeeName}</td>
                            <td>${getMonthName(payslip.month)}</td>
                            <td>${payslip.year}</td>
                            <td>‚Çπ${parseFloat(payslip.grossSalary || 0).toLocaleString('en-IN')}</td>
                            <td>‚Çπ${parseFloat(payslip.netSalary || 0).toLocaleString('en-IN')}</td>
                            <td>${createdAt || 'N/A'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-primary" onclick="viewPayslip('${doc.id}')">View</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading payslips:', error);
                showAlert('Error loading payslips', 'danger');
            }
        }

        function loadSettings() {
            document.getElementById('settingsName').textContent = currentUserData.name;
            document.getElementById('settingsEmail').textContent = currentUserData.email;
            document.getElementById('settingsRole').textContent = currentUserData.role;
        }

        // ===================================
        // COMPANY MANAGEMENT
        // ===================================

        function openAddCompanyModal() {
            document.getElementById('addCompanyModal').classList.add('active');
        }

        async function handleAddCompany(event) {
            event.preventDefault();
            
            try {
                const companyData = {
                    name: document.getElementById('companyName').value,
                    pan: document.getElementById('companyPAN').value,
                    tan: document.getElementById('companyTAN').value,
                    pf: document.getElementById('companyPF').value,
                    esi: document.getElementById('companyESI').value,
                    address: document.getElementById('companyAddress').value,
                    adminName: document.getElementById('adminName').value,
                    adminEmail: document.getElementById('adminEmail').value,
                    adminPhone: document.getElementById('adminPhone').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                // Create company document
                const companyRef = await db.collection('companies').add(companyData);
                
                // Create company admin account
                const tempPassword = generatePassword();
                
                // Note: In production, you should use Firebase Admin SDK for this
                // For now, we'll create the user document without auth
                const adminData = {
                    name: companyData.adminName,
                    email: companyData.adminEmail,
                    phoneNumber: companyData.adminPhone,
                    role: 'Company Admin',
                    companyId: companyRef.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    tempPassword: tempPassword
                };
                
                showAlert(`Company created successfully! Admin temp password: ${tempPassword}`, 'success');
                closeModal('addCompanyModal');
                event.target.reset();
                
                await loadCompanies();
                await loadCompanySelector();
                await loadDashboardData();
            } catch (error) {
                console.error('Error creating company:', error);
                showAlert('Error creating company. Please try again.', 'danger');
            }
        }

        // ===================================
        // EMPLOYEE MANAGEMENT
        // ===================================

        function openAddEmployeeModal() {
            if (!currentCompanyId && currentUserData.role === 'Super Admin') {
                showAlert('Please select a company first', 'warning');
                return;
            }
            document.getElementById('addEmployeeModal').classList.add('active');
        }

        async function handleAddEmployee(event) {
            event.preventDefault();
            
            try {
                const companyId = currentCompanyId || currentUserData.companyId;
                
                if (!companyId) {
                    showAlert('Company not selected', 'danger');
                    return;
                }
                
                const employeeData = {
                    companyId: companyId,
                    employeeId: document.getElementById('employeeId').value,
                    name: document.getElementById('employeeName').value,
                    email: document.getElementById('employeeEmail').value,
                    phoneNumber: document.getElementById('employeePhone').value,
                    designation: document.getElementById('employeeDesignation').value,
                    department: document.getElementById('employeeDepartment').value,
                    dateOfJoining: document.getElementById('employeeDOJ').value,
                    basicSalary: parseFloat(document.getElementById('employeeBasicSalary').value),
                    pan: document.getElementById('employeePAN').value,
                    uan: document.getElementById('employeeUAN').value,
                    bankAccount: document.getElementById('employeeBank').value,
                    hasWebsiteAccess: document.getElementById('employeeAccess').checked,
                    status: 'Active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('employees').add(employeeData);
                
                showAlert('Employee added successfully!', 'success');
                closeModal('addEmployeeModal');
                event.target.reset();
                
                await loadEmployees();
                await loadDashboardData();
            } catch (error) {
                console.error('Error adding employee:', error);
                showAlert('Error adding employee. Please try again.', 'danger');
            }
        }

        // ===================================
        // PAYSLIP MANAGEMENT
        // ===================================

        function openGeneratePayslipModal(employeeId, employeeName, basicSalary) {
            document.getElementById('payslipEmployeeId').value = employeeId;
            document.getElementById('payslipEmployeeName').value = employeeName;
            document.getElementById('payslipBasicSalary').value = basicSalary;
            
            // Set current month and year
            const now = new Date();
            document.getElementById('payslipMonth').value = (now.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('payslipYear').value = now.getFullYear();
            
            openModal('generatePayslipModal');
        }

        async function handleGeneratePayslip(event) {
            event.preventDefault();
            
            try {
                const employeeId = document.getElementById('payslipEmployeeId').value;
                const employeeDoc = await db.collection('employees').doc(employeeId).get();
                
                if (!employeeDoc.exists) {
                    showAlert('Employee not found', 'danger');
                    return;
                }
                
                const employee = employeeDoc.data();
                const basicSalary = parseFloat(document.getElementById('payslipBasicSalary').value);
                const workingDays = parseInt(document.getElementById('workingDays').value);
                const paidDays = parseInt(document.getElementById('paidDays').value);
                const additionalAllowances = parseFloat(document.getElementById('additionalAllowances').value) || 0;
                const otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
                
                // Calculate components
                const hra = basicSalary * 0.4; // 40% of basic
                const da = basicSalary * 0.2; // 20% of basic
                const grossSalary = basicSalary + hra + da + additionalAllowances;
                
                // Calculate deductions
                const pf = basicSalary * 0.12; // 12% of basic
                const esi = grossSalary <= 21000 ? grossSalary * 0.0075 : 0; // 0.75% if gross <= 21000
                const lop = paidDays < workingDays ? (basicSalary / workingDays) * (workingDays - paidDays) : 0;
                
                const totalDeductions = pf + esi + lop + otherDeductions;
                const netSalary = grossSalary - totalDeductions;
                
                const payslipData = {
                    companyId: employee.companyId,
                    employeeId: employeeId,
                    employeeName: employee.name,
                    employeeDesignation: employee.designation,
                    month: document.getElementById('payslipMonth').value,
                    year: parseInt(document.getElementById('payslipYear').value),
                    workingDays: workingDays,
                    paidDays: paidDays,
                    basicSalary: basicSalary,
                    hra: hra,
                    da: da,
                    additionalAllowances: additionalAllowances,
                    grossSalary: grossSalary,
                    pf: pf,
                    esi: esi,
                    lop: lop,
                    otherDeductions: otherDeductions,
                    totalDeductions: totalDeductions,
                    netSalary: netSalary,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    generatedBy: currentUser.uid,
                    generatedByName: currentUserData.name
                };
                
                const payslipRef = await db.collection('payslips').add(payslipData);
                
                showAlert('Payslip generated successfully!', 'success');
                closeModal('generatePayslipModal');
                
                await loadPayslips();
                await loadDashboardData();
                
                // View the generated payslip
                setTimeout(() => viewPayslip(payslipRef.id), 500);
            } catch (error) {
                console.error('Error generating payslip:', error);
                showAlert('Error generating payslip. Please try again.', 'danger');
            }
        }

        async function viewPayslip(payslipId) {
            try {
                const payslipDoc = await db.collection('payslips').doc(payslipId).get();
                
                if (!payslipDoc.exists) {
                    showAlert('Payslip not found', 'danger');
                    return;
                }
                
                const payslip = payslipDoc.data();
                
                // Get company details
                const companyDoc = await db.collection('companies').doc(payslip.companyId).get();
                const company = companyDoc.data();
                
                const payslipHtml = `
                    <div class="payslip-print">
                        <div class="payslip-header">
                            <h2>${company.name}</h2>
                            <p>${company.address || ''}</p>
                            <p>PAN: ${company.pan || 'N/A'} | TAN: ${company.tan || 'N/A'}</p>
                            <h3 style="margin-top: 20px;">PAYSLIP FOR ${getMonthName(payslip.month)} ${payslip.year}</h3>
                        </div>
                        
                        <table class="payslip-table">
                            <tr>
                                <th>Employee Name:</th>
                                <td>${payslip.employeeName}</td>
                                <th>Designation:</th>
                                <td>${payslip.employeeDesignation || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>Working Days:</th>
                                <td>${payslip.workingDays}</td>
                                <th>Paid Days:</th>
                                <td>${payslip.paidDays}</td>
                            </tr>
                        </table>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 10px;">EARNINGS</h4>
                        <table class="payslip-table">
                            <tr>
                                <th>Component</th>
                                <th style="text-align: right;">Amount (‚Çπ)</th>
                            </tr>
                            <tr>
                                <td>Basic Salary</td>
                                <td style="text-align: right;">${formatCurrency(payslip.basicSalary)}</td>
                            </tr>
                            <tr>
                                <td>HRA (40%)</td>
                                <td style="text-align: right;">${formatCurrency(payslip.hra)}</td>
                            </tr>
                            <tr>
                                <td>DA (20%)</td>
                                <td style="text-align: right;">${formatCurrency(payslip.da)}</td>
                            </tr>
                            ${payslip.additionalAllowances > 0 ? `
                            <tr>
                                <td>Additional Allowances</td>
                                <td style="text-align: right;">${formatCurrency(payslip.additionalAllowances)}</td>
                            </tr>
                            ` : ''}
                            <tr style="font-weight: 600;">
                                <td>Gross Salary</td>
                                <td style="text-align: right;">${formatCurrency(payslip.grossSalary)}</td>
                            </tr>
                        </table>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 10px;">DEDUCTIONS</h4>
                        <table class="payslip-table">
                            <tr>
                                <th>Component</th>
                                <th style="text-align: right;">Amount (‚Çπ)</th>
                            </tr>
                            <tr>
                                <td>PF (12%)</td>
                                <td style="text-align: right;">${formatCurrency(payslip.pf)}</td>
                            </tr>
                            ${payslip.esi > 0 ? `
                            <tr>
                                <td>ESI (0.75%)</td>
                                <td style="text-align: right;">${formatCurrency(payslip.esi)}</td>
                            </tr>
                            ` : ''}
                            ${payslip.lop > 0 ? `
                            <tr>
                                <td>Loss of Pay</td>
                                <td style="text-align: right;">${formatCurrency(payslip.lop)}</td>
                            </tr>
                            ` : ''}
                            ${payslip.otherDeductions > 0 ? `
                            <tr>
                                <td>Other Deductions</td>
                                <td style="text-align: right;">${formatCurrency(payslip.otherDeductions)}</td>
                            </tr>
                            ` : ''}
                            <tr style="font-weight: 600;">
                                <td>Total Deductions</td>
                                <td style="text-align: right;">${formatCurrency(payslip.totalDeductions)}</td>
                            </tr>
                        </table>
                        
                        <table class="payslip-table" style="margin-top: 20px; background: #f0f0f0;">
                            <tr style="font-weight: 600; font-size: 16px;">
                                <td>NET SALARY</td>
                                <td style="text-align: right;">${formatCurrency(payslip.netSalary)}</td>
                            </tr>
                        </table>
                        
                        <p style="margin-top: 30px; font-size: 12px; color: #666;">
                            Generated on: ${payslip.createdAt?.toDate().toLocaleDateString('en-IN')}<br>
                            Generated by: ${payslip.generatedByName}
                        </p>
                        
                        <p style="margin-top: 30px; font-size: 11px; color: #999;">
                            This is a computer-generated payslip and does not require a signature.
                        </p>
                    </div>
                `;
                
                document.getElementById('payslipContent').innerHTML = payslipHtml;
                openModal('viewPayslipModal');
            } catch (error) {
                console.error('Error viewing payslip:', error);
                showAlert('Error loading payslip', 'danger');
            }
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================

        function generatePassword() {
            const length = 8;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let password = "";
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }

        function getMonthName(monthNumber) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[parseInt(monthNumber) - 1];
        }

        function formatCurrency(amount) {
            return parseFloat(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function editCompany(companyId) {
            showAlert('Edit functionality coming soon...', 'warning');
        }

        function editEmployee(employeeId) {
            showAlert('Edit functionality coming soon...', 'warning');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Payroll Manager Pro initialized');
        });
    </script>
</body>
</html>